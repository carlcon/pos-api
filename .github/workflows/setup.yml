# POS API - Initial Server Setup
# Run this ONCE on a fresh DigitalOcean Droplet
# Trigger manually from GitHub Actions → "Run workflow"

name: Setup Server

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "setup" to confirm (this should only run once)'
        required: true
        default: ''

jobs:
  setup:
    name: Setup DigitalOcean Droplet
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'setup'
    environment: Production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Add server to known hosts
        env:
          DO_HOST: ${{ secrets.DO_HOST }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H $DO_HOST >> ~/.ssh/known_hosts

      - name: Setup SSH key
        run: |
          echo "${{ secrets.DO_SSH_KEY }}" > do_key.pem
          chmod 600 do_key.pem

      - name: Run setup script on Droplet
        env:
          DO_HOST: ${{ secrets.DO_HOST }}
        run: |
          # Copy setup script to server
          scp -i do_key.pem scripts/setup-droplet.sh root@$DO_HOST:/root/setup-droplet.sh
          
          # Run setup script
          ssh -i do_key.pem root@$DO_HOST 'bash -s' << 'SETUP_SCRIPT'
          chmod +x /root/setup-droplet.sh
          /root/setup-droplet.sh
          
          # Verify Docker is working
          docker --version
          docker-compose --version
          
          # Show system info
          echo ""
          echo "=== System Info ==="
          free -h
          df -h /
          SETUP_SCRIPT

      - name: Cleanup SSH key
        if: always()
        run: rm -f do_key.pem

      - name: Setup complete
        run: |
          echo "✅ Server setup completed!"
          echo ""
          echo "Next steps:"
          echo "1. Push to master branch to trigger deployment"
          echo "2. Or manually run the 'Deploy POS API' workflow"
          echo ""
          echo "After deployment, create superuser:"
          echo "  ssh root@\$DO_HOST"
          echo "  docker exec -it pos-api python manage.py createsuperuser"
